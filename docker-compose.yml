include:
  - path: ./fossil-offchain-processor/crates/server/docker-compose.yml


services:
  pitchlake_db:
    image: postgres:16
    command: -p 5433
    environment:
      POSTGRES_DB: pitchlake_db
      POSTGRES_USER: pitchlake_user
      POSTGRES_PASSWORD: pitchlake_password
    ports:
      - "5433:5433"
    volumes:
      - postgres_data:/var/lib/postgresql/pitchlake_data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pitchlake_user -d pitchlake_db -p 5433"]
      interval: 5s
      timeout: 5s
      retries: 5

  juno_plugin:
    build:
      context: ./pitchlake-plugin-juno
      dockerfile: Dockerfile
    environment:
      DB_URL: postgres://pitchlake_user:pitchlake_password@pitchlake_db:5433/pitchlake_db
    depends_on:
      pitchlake_db:
        condition: service_healthy
    ports:
      - "6060:6060"
    healthcheck:
      test: ["CMD", "curl", "-s", "-X", "POST", 
            "-H", "Content-Type: application/json",
            "--data", '{"jsonrpc":"2.0","method":"juno_version","params":[],"id":1}',
            "http://localhost:6060"]
      interval: 10s
      timeout: 10s
      retries: 5

  pitchlake-contracts-deployment:
    build:
      context: ./pitchlake_starknet
      dockerfile: Dockerfile
      args:
        - SIGNER_PRIVATE_KEY=${SIGNER_PRIVATE_KEY}
        - DEVNET_RPC=http://juno_plugin:6060
        - SIGNER_ADDRESS=${SIGNER_ADDRESS}
        - FOSSIL_PROCESSOR_ADDRESS=${FOSSIL_PROCESSOR_ADDRESS}
        - VAULT_ROUND_DURATION=${VAULT_ROUND_DURATION}
        - ARGENT_ADDRESS=${ARGENT_WALLET_ADDRESS}
        - ARGENT_SALT=${ARGENT_WALLET_SALT}
        - ARGENT_CONSTRUCTOR_ARG1=${ARGENT_WALLET_CONSTRUCTOR_ARG1}

    volumes:
      - shared:/contracts/katana
    depends_on:
      juno_plugin:
        condition: service_healthy
  
  pitchlake_websocket:
    build:
      context: ./pitchlake_db_server
      dockerfile: Dockerfile
    environment:
     APP_URL: http://frontend:3003
     DB_URL: postgres://pitchlake_user:pitchlake_password@pitchlake_db:5433/pitchlake_db
    ports:
      - "8080:8080"
    depends_on:
      pitchlake-contracts-deployment:
        condition: service_completed_successfully

  frontend:
    build:
      context: ./pitchlake-ui-new
      dockerfile: Dockerfile.no-build
    ports:
      - "3003:3003"
    volumes:
      - shared:/app/env
    environment:
      - NODE_ENV=production
      - PORT=3003
      - NEXT_PUBLIC_ENVIRONMENT=${NEXT_PUBLIC_ENVIRONMENT}
      - NEXT_PUBLIC_RPC_URL_MAINNET=${NEXT_PUBLIC_RPC_URL_MAINNET}
      - NEXT_PUBLIC_RPC_URL_SEPOLIA=${NEXT_PUBLIC_RPC_URL_SEPOLIA}
      - NEXT_PUBLIC_RPC_URL_DEVNET=${DEVNET_RPC}
      - NEXT_PUBLIC_RPC_URL_JUNO_DEVNET=http://localhost:6060
      - NEXT_PUBLIC_WS_URL=http://pitchlake_websocket:8080
      - FOSSIL_API_KEY=${FOSSIL_API_KEY}
      - NEXT_PUBLIC_FOSSIL_API_URL=http://app:3000
  
    command: >
      /bin/sh -c '
      cd /app/env &&
      export NEXT_PUBLIC_VAULT_ADDRESSES=$$(grep VAULT_ADDRESS deployment_addresses.env | cut -d"=" -f2) &&
      cd /app &&
      env | grep NEXT_PUBLIC_VAULT_ADDRESSES &&
      pnpm run build &&
      exec pnpm start -p 3003'
    depends_on:
      pitchlake-contracts-deployment:
        condition: service_completed_successfully

volumes:
  postgres_data:
  shared: